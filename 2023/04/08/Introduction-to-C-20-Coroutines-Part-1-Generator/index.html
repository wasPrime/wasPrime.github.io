

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="wasPrime">
  <meta name="keywords" content="">
  
    <meta name="description" content="Why corouties were imported in C++20? In order to explain it, we could begin with some examples about Fibonacci sequences. FibonacciAt the beginning, we can write down code like below. 012345678910111">
<meta property="og:type" content="article">
<meta property="og:title" content="Introduction to C++20 Coroutines - Part 1 Generator">
<meta property="og:url" content="http://wasprime.github.io/2023/04/08/Introduction-to-C-20-Coroutines-Part-1-Generator/index.html">
<meta property="og:site_name" content="wasPrime&#39;s Blog">
<meta property="og:description" content="Why corouties were imported in C++20? In order to explain it, we could begin with some examples about Fibonacci sequences. FibonacciAt the beginning, we can write down code like below. 012345678910111">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-04-08T13:17:21.000Z">
<meta property="article:modified_time" content="2023-04-09T14:33:40.545Z">
<meta property="article:author" content="wasPrime">
<meta property="article:tag" content="cpp">
<meta property="article:tag" content="cpp20">
<meta property="article:tag" content="stl">
<meta property="article:tag" content="coroutines">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>Introduction to C++20 Coroutines - Part 1 Generator - wasPrime&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"wasprime.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>wasPrime</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Introduction to C++20 Coroutines - Part 1 Generator"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-04-08 21:17" pubdate>
          April 8, 2023 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          15k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          30 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Introduction to C++20 Coroutines - Part 1 Generator</h1>
            
            
              <div class="markdown-body">
                
                <p>Why corouties were imported in C++20? In order to explain it, we could begin with some examples about Fibonacci sequences.</p>
<h2 id="Fibonacci"><a href="#Fibonacci" class="headerlink" title="Fibonacci"></a>Fibonacci</h2><p>At the beginning, we can write down code like below.</p>
<h3 id="0"><a href="#0" class="headerlink" title="0"></a>0</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">std::vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">get_fibonacci</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> </span>&#123;<br>    std::vector&lt;<span class="hljs-type">int</span>&gt; v;<br>    v.<span class="hljs-built_in">reserve</span>(n);<br><br>    <span class="hljs-type">int</span> a = <span class="hljs-number">0</span>, b = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) &#123;<br>        v.<span class="hljs-built_in">push_back</span>(b);<br>        <span class="hljs-type">int</span> sum = a + b;<br>        a = b;<br>        b = sum;<br>    &#125;<br>    <span class="hljs-keyword">return</span> v;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    std::vector&lt;<span class="hljs-type">int</span>&gt; v = <span class="hljs-built_in">get_fibonacci</span>(<span class="hljs-number">10</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i : v) &#123;<br>        std::cout &lt;&lt; i &lt;&lt; std::endl;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>This function receives an integer that indicates the size of the Fibonacci sequence needed.</p>
<p>However, there are a few disadvantages:</p>
<ol>
<li>It returns an vector to store the temporary result, and the vector is just for traversalling once. The occupied space of this temporary vector can’t be ignored in case the needed size of sequence is pretty large.</li>
<li>It can’t support the occasion if we would like to get an infinite sequence.</li>
</ol>
<h3 id="1"><a href="#1" class="headerlink" title="1"></a>1</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">generate_fibonacci</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> a = <span class="hljs-number">0</span>, b = <span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> sum = a + b;<br>    a = b;<br>    b = sum;<br>    <span class="hljs-keyword">return</span> a;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; ++i) &#123;<br>        std::cout &lt;&lt; <span class="hljs-built_in">generate_fibonacci</span>() &lt;&lt; std::endl;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>As the code rewritten, it fixes the issues above with static variables. It not only uses minimum occupied space, but also supports for generating an infinite sequence.</p>
<p>But it still looks not enough to be considered as perfect. <strong>If we would like to get multiple independent sequences?</strong> After all, static variables can be initialized just once, and they have own states afterward.</p>
<h3 id="2"><a href="#2" class="headerlink" title="2"></a>2</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FibonacciGenerator</span> &#123;<br><span class="hljs-keyword">public</span>:<br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">next</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-type">int</span> sum = a + b;<br>        a = b;<br>        b = sum;<br>        <span class="hljs-keyword">return</span> a;<br>    &#125;<br><br><span class="hljs-keyword">private</span>:<br>    <span class="hljs-type">int</span> a&#123;<span class="hljs-number">0</span>&#125;;<br>    <span class="hljs-type">int</span> b&#123;<span class="hljs-number">1</span>&#125;;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    FibonacciGenerator fibonacci_generator;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; ++i) &#123;<br>        std::cout &lt;&lt; fibonacci_generator.<span class="hljs-built_in">next</span>() &lt;&lt; std::endl;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>From the thought about states, we can easily to encapsulate them in a generator class and update their states within the generator’s member function.</p>
<h2 id="Bring-Coroutines-in"><a href="#Bring-Coroutines-in" class="headerlink" title="Bring Coroutines in"></a>Bring Coroutines in</h2><p>The states look easy to update because the context is simple. Trouble is coming if we have to do something with complicated context such as throw elements from two or even more vectors in a particular order like round robin. In many cases, we need to maintain the update of various states even a state machine.</p>
<p>Coroutines are brought in to reduce the cost of mantaining various states so that we focus on the work code itself.</p>
<h2 id="Coroutines-in-Python"><a href="#Coroutines-in-Python" class="headerlink" title="Coroutines in Python"></a>Coroutines in Python</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Generator<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">finonacci</span>() -&gt; Generator[<span class="hljs-built_in">int</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>]:<br>    a, b = <span class="hljs-number">0</span>, <span class="hljs-number">1</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        a, b = b, a + b<br>        <span class="hljs-keyword">yield</span> a<br><br><br>fibonacci_gen = finonacci()<br><br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(fibonacci_gen))<br></code></pre></td></tr></table></figure>

<p>When <code>finonacci()</code> is called, the generator is returned but the function doesn’t start to run yet. When <code>next(fibonacci_gen)</code> is called every time, the execution inside the <code>finonacci</code> function runs until it encounters the keyword <code>yield</code>. It stores the current execution, suspends and returns to the outside execution. After <code>next(fibonacci_gen)</code> is called again, the execution inside the <code>finonacci</code> function will resume and continue to run until it encounters the keyword <code>yield</code> again.</p>
<p>The execution workflow is actually controlled with the help of compiler.</p>
<h2 id="Coroutines-in-C"><a href="#Coroutines-in-C" class="headerlink" title="Coroutines in C++"></a>Coroutines in C++</h2><h3 id="Declaration-of-coroutine"><a href="#Declaration-of-coroutine" class="headerlink" title="Declaration of coroutine"></a>Declaration of coroutine</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">fibonacci_generator <span class="hljs-title">fibonacci</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-type">int</span> a = <span class="hljs-number">0</span>, b = <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-type">int</span> sum = a + b;<br>        a = b;<br>        b = sum;<br><br>        <span class="hljs-keyword">co_yield</span> a;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>The declaration of coroutines in C++ is similar to Python, and the execution flow is also easy to understand. Isn’t it?</p>
<p>There are 3 keywords <code>co_yield</code> <code>co_await</code> <code>co_return</code> are brought in in C++20. Once there are keywords among them occur in a scope, it’s actually a coroutine rather than a subroutine used in traditional C++. We only use <code>co_yield</code> here.</p>
<p>Now we definitely have at least 2 questions:</p>
<ol>
<li>How to implement <code>fibonacci_generator</code>?</li>
<li>How to use <code>fibonacci()</code>?</li>
</ol>
<p>I will explain them on by one.</p>
<h3 id="Implementation-of-generators"><a href="#Implementation-of-generators" class="headerlink" title="Implementation of generators"></a>Implementation of generators</h3><p>Apart from subroutines we are familiar with, the return type of coroutines must be written in a particular standard, otherwise it won’t pass compiling. Let’s follow the complaint from compiler to fill the needed contents little by little.</p>
<div class="note note-info">
            <p>The below code is compiled under <code>gcc 11.3.0</code>.</p>
          </div>

<div class="note note-warning">
            <p>So far (March 2023), some compilers don’t provide complete support about coroutines. For instance, in clang, header file about coroutine is <code>&lt;experimental/coroutine&gt;</code>, and components about coroutine are in namespace <code>std::experimental</code>.</p>
          </div>

<h4 id="Declaration-of-fibonacci-generator"><a href="#Declaration-of-fibonacci-generator" class="headerlink" title="Declaration of fibonacci_generator"></a>Declaration of <code>fibonacci_generator</code></h4><p>Assume we write the definition of <code>fibonacci_generator</code>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;coroutine&gt;</span> <span class="hljs-comment">// It wouldn&#x27;t be written in the code snippet afterwards</span></span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">fibonacci_generator</span> &#123;&#125;;<br></code></pre></td></tr></table></figure>

<p>There is a complaint from compiler:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs log">class &quot;std::__n4861::coroutine_traits&lt;fibonacci_generator, int&gt;&quot; has no member &quot;promise_type&quot;<br></code></pre></td></tr></table></figure>

<p>Add a struct or class <code>promise_type</code> in <code>fibonacci_generator</code>.</p>
<h4 id="Declaration-of-promise-type"><a href="#Declaration-of-promise-type" class="headerlink" title="Declaration of promise_type"></a>Declaration of <code>promise_type</code></h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">fibonacci_generator</span> &#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">promise_type</span> &#123;&#125;;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>There are several complaints from compiler:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs log">no member named &#x27;initial_suspend&#x27; in &#x27;std::__n4861::__coroutine_traits_impl&lt;fibonacci_generator, void&gt;::promise_type&#x27; &#123;aka &#x27;fibonacci_generator::promise_type&#x27;&#125;<br>no member named &#x27;unhandled_exception&#x27; in &#x27;std::__n4861::__coroutine_traits_impl&lt;fibonacci_generator, void&gt;::promise_type&#x27; &#123;aka &#x27;fibonacci_generator::promise_type&#x27;&#125;<br>no member named &#x27;final_suspend&#x27; in &#x27;std::__n4861::__coroutine_traits_impl&lt;fibonacci_generator, void&gt;::promise_type&#x27; &#123;aka &#x27;fibonacci_generator::promise_type&#x27;&#125;<br>no member named &#x27;get_return_object&#x27; in &#x27;std::__n4861::__coroutine_traits_impl&lt;fibonacci_generator, void&gt;::promise_type&#x27; &#123;aka &#x27;fibonacci_generator::promise_type&#x27;&#125;<br>no member named &#x27;yield_value&#x27; in &#x27;std::__n4861::__coroutine_traits_impl&lt;fibonacci_generator, void&gt;::promise_type&#x27; &#123;aka &#x27;fibonacci_generator::promise_type&#x27;&#125;<br></code></pre></td></tr></table></figure>

<h4 id="Definition-of-promise-type"><a href="#Definition-of-promise-type" class="headerlink" title="Definition of promise_type"></a>Definition of <code>promise_type</code></h4><p>Since there are a few functions and contents, let me fill them in and explain them in comments.</p>
<blockquote>
<p>In order to distinguish the execution time, I add some output to help understand.</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">fibonacci_generator</span> &#123;<br>    <span class="hljs-comment">// The functionality of `promise_type`:</span><br>    <span class="hljs-comment">// 1. Stores context.</span><br>    <span class="hljs-comment">// 2. Controls suspension and resumption by implementing the following functions</span><br>    <span class="hljs-comment">//    `get_return_object` `initial_suspend` `final_suspend` `yield_value`.</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">promise_type</span> &#123;<br>        <span class="hljs-built_in">promise_type</span>() &#123;<br>            std::cout &lt;&lt; <span class="hljs-string">&quot;promise_type()&quot;</span> &lt;&lt; std::endl;<br>        &#125;<br>        ~<span class="hljs-built_in">promise_type</span>() &#123;<br>            std::cout &lt;&lt; <span class="hljs-string">&quot;~promise_type() &quot;</span> &lt;&lt; std::endl;<br>        &#125;<br><br>        <span class="hljs-type">int</span> current_&#123;<span class="hljs-number">0</span>&#125;;  <span class="hljs-comment">// store the state/value</span><br><br>        <span class="hljs-comment">// Execute when the coroutine begins and to generate the result object at a particular memory space.</span><br>        <span class="hljs-comment">// Return this object when the coroutine returns.</span><br>        <span class="hljs-function">fibonacci_generator <span class="hljs-title">get_return_object</span><span class="hljs-params">()</span> </span>&#123;<br>            std::cout &lt;&lt; <span class="hljs-string">&quot;fibonacci_generator::promise_type::get_return_object&quot;</span> &lt;&lt; std::endl;<br>            <span class="hljs-keyword">return</span> std::coroutine_handle&lt;promise_type&gt;::<span class="hljs-built_in">from_promise</span>(<br>                *<span class="hljs-keyword">this</span>);  <span class="hljs-comment">// convert implicitly from `std::coroutine_handle&lt;promise_type&gt;` to `fibonacci_generator`</span><br>        &#125;<br><br>        <span class="hljs-comment">// Execute when the coroutine begins.</span><br>        <span class="hljs-comment">//</span><br>        <span class="hljs-comment">// 1) If its return type is `std::suspend_always`, the coroutine suspends and the execution returns to outside.</span><br>        <span class="hljs-comment">//</span><br>        <span class="hljs-comment">// 2) If its return type is `std::suspend_never`, after coroutine begins, it continues to run until encounters</span><br>        <span class="hljs-comment">//    keywords about coroutine Its return type can be customized flexibly as long as it implements the functions</span><br>        <span class="hljs-comment">//    `await_ready` `await_suspend` `await_resume`.</span><br>        <span class="hljs-function">std::suspend_always <span class="hljs-title">initial_suspend</span><span class="hljs-params">()</span> </span>&#123;<br>            std::cout &lt;&lt; <span class="hljs-string">&quot;fibonacci_generator::promise_type::initial_suspend&quot;</span> &lt;&lt; std::endl;<br>            <span class="hljs-keyword">return</span> &#123;&#125;;<br>        &#125;<br><br>        <span class="hljs-comment">// Execute when the coroutine ends (`co_return` is called or arrives the end of the scope).</span><br>        <span class="hljs-comment">//</span><br>        <span class="hljs-comment">// 1) If its return type is `std::suspend_always`, it will keep the context of coroutine and `promise_type`</span><br>        <span class="hljs-comment">//    object alive and give control of the release to user.</span><br>        <span class="hljs-comment">//</span><br>        <span class="hljs-comment">// 2) If its return type is `std::suspend_never`, it will release them automatically.</span><br>        <span class="hljs-comment">//</span><br>        <span class="hljs-comment">//     a) After that, if user tries to access `promise_type` object, it means it will access wild resources.</span><br>        <span class="hljs-comment">//        It should be avoided by user self.</span><br>        <span class="hljs-comment">//</span><br>        <span class="hljs-comment">//     b) After that, if user tries to call `handle_.destroy()`, it will release resource secondly like</span><br>        <span class="hljs-comment">//        double free. It should also be avoided.</span><br>        <span class="hljs-function">std::suspend_always <span class="hljs-title">final_suspend</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span> </span>&#123;<br>            std::cout &lt;&lt; <span class="hljs-string">&quot;fibonacci_generator::promise_type::final_suspend&quot;</span> &lt;&lt; std::endl;<br>            <span class="hljs-keyword">return</span> &#123;&#125;;<br>        &#125;<br><br>        <span class="hljs-comment">// Execute when `co_yield` is called in the coroutine.</span><br>        <span class="hljs-comment">// It receives the input value from `co_yield` and we can store values or update states.</span><br>        <span class="hljs-function">std::suspend_always <span class="hljs-title">yield_value</span><span class="hljs-params">(<span class="hljs-type">int</span> value)</span> </span>&#123;<br>            std::cout &lt;&lt; <span class="hljs-string">&quot;fibonacci_generator::promise_type::yield_value&quot;</span> &lt;&lt; std::endl;<br>            current_ = value;<br>            <span class="hljs-keyword">return</span> &#123;&#125;;<br>        &#125;<br><br>        <span class="hljs-comment">// Process in case there is exception thrown from coroutine</span><br>        <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">unhandled_exception</span><span class="hljs-params">()</span> </span>&#123;<br>            std::<span class="hljs-built_in">terminate</span>();<br>        &#125;<br>    &#125;;<br><br>    std::coroutine_handle&lt;promise_type&gt; handle_;  <span class="hljs-comment">// the handle of coroutine</span><br><br>    <span class="hljs-built_in">fibonacci_generator</span>(std::coroutine_handle&lt;promise_type&gt; handle) : handle_&#123;handle&#125; &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;fibonacci_generator()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br><br>    ~<span class="hljs-built_in">fibonacci_generator</span>() &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;~fibonacci_generator()&quot;</span> &lt;&lt; std::endl;<br><br>        std::cout &lt;&lt; <span class="hljs-string">&quot;before handle_.destroy()&quot;</span> &lt;&lt; std::endl;<br>        handle_.<span class="hljs-built_in">destroy</span>();<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;after handle_.destroy()&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="Usage-of-fibonacci-generator"><a href="#Usage-of-fibonacci-generator" class="headerlink" title="Usage of fibonacci_generator"></a>Usage of <code>fibonacci_generator</code></h3><p>Before we use <code>fibonacci_generator</code>, add a member function <code>operator()</code> into it to call it like a function calling.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">fibonacci_generator</span> &#123;<br>    <span class="hljs-comment">// Other members...</span><br><br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">operator</span><span class="hljs-params">()</span><span class="hljs-params">()</span> </span>&#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;fibonacci_generator::operator()&quot;</span> &lt;&lt; std::endl;<br>        <span class="hljs-keyword">if</span> (!handle_.<span class="hljs-built_in">done</span>()) &#123;<br>            handle_.<span class="hljs-built_in">resume</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> handle_.<span class="hljs-built_in">promise</span>().current_;<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function">fibonacci_generator <span class="hljs-title">fib</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-type">int</span> a = <span class="hljs-number">0</span>, b = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-type">int</span> sum = a + b;<br>        a = b;<br>        b = sum;<br><br>        std::cout &lt;&lt; <span class="hljs-string">&quot;before co_yield&quot;</span> &lt;&lt; std::endl;<br>        <span class="hljs-keyword">co_yield</span> a;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;after co_yield&quot;</span> &lt;&lt; std::endl;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;-----------------------------------before fib()&quot;</span> &lt;&lt; std::endl;<br>    fibonacci_generator f = <span class="hljs-built_in">fib</span>();<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;-----------------------------------after fib()&quot;</span> &lt;&lt; std::endl;<br><br>    std::cout &lt;&lt; <span class="hljs-string">&quot;-----------------------------------loop begins&quot;</span> &lt;&lt; std::endl;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;-----------------------------------begin: &quot;</span> &lt;&lt; i &lt;&lt; std::endl;<br>        std::cout &lt;&lt; <span class="hljs-built_in">f</span>() &lt;&lt; std::endl;<br>        std::cout &lt;&lt; <span class="hljs-string">&quot;-----------------------------------end: &quot;</span> &lt;&lt; i &lt;&lt; std::endl;<br>    &#125;<br>    std::cout &lt;&lt; <span class="hljs-string">&quot;-----------------------------------loop ends&quot;</span> &lt;&lt; std::endl;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="Output"><a href="#Output" class="headerlink" title="Output"></a>Output</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs log">-----------------------------------before fib()<br>promise_type()<br>fibonacci_generator::promise_type::get_return_object<br>fibonacci_generator()<br>fibonacci_generator::promise_type::initial_suspend<br>-----------------------------------after fib()<br>-----------------------------------loop begins<br>-----------------------------------begin: 0<br>fibonacci_generator::operator()<br>fib()<br>before co_yield<br>fibonacci_generator::promise_type::yield_value<br>1<br>-----------------------------------end: 0<br>-----------------------------------begin: 1<br>fibonacci_generator::operator()<br>after co_yield<br>before co_yield<br>fibonacci_generator::promise_type::yield_value<br>1<br>-----------------------------------end: 1<br>-----------------------------------begin: 2<br>fibonacci_generator::operator()<br>after co_yield<br>before co_yield<br>fibonacci_generator::promise_type::yield_value<br>2<br>-----------------------------------end: 2<br>-----------------------------------loop ends<br>~fibonacci_generator()<br>before handle_.destroy()<br>~promise_type() <br>after handle_.destroy()<br></code></pre></td></tr></table></figure>

<div class="note note-primary">
            <p>To understand the life cycle of coroutines or other cases, there is a useful method to insert some output at the beginning and the end of functions and other any necessary locations. :)</p>
          </div>

<h2 id="More-Explanations"><a href="#More-Explanations" class="headerlink" title="More Explanations"></a>More Explanations</h2><h3 id="1-How-to-understand-promise-type"><a href="#1-How-to-understand-promise-type" class="headerlink" title="1. How to understand promise_type?"></a>1. How to understand <code>promise_type</code>?</h3><p>It indicates the situation of the coroutine. It’s like a controller that not only stores states and context but also controls coroutine’s suspension and resumption.</p>
<h3 id="2-How-to-understand-coroutine-handle"><a href="#2-How-to-understand-coroutine-handle" class="headerlink" title="2. How to understand coroutine_handle?"></a>2. How to understand <code>coroutine_handle</code>?</h3><p>As the name implies, it’s a handle to a coroutine. Haha…</p>
<p>I have an informal idea to understand it. We might consider it as the pointer to the coroutine. <code>coroutine_handle&lt;&gt;</code> points to the coroutine itself and <code>coroutine_handle&lt;promise_type&gt;</code> points to the <code>promise_type</code> object.</p>
<ul>
<li>With <code>coroutine_handle&lt;promise_type&gt;</code> we’are able to access the <code>promise_type</code> to read or write states inside the return type(<code>fibonacci_generator</code> is the return type in above example) or even outside the coroutine.</li>
<li>We can just use <code>coroutine_handle&lt;&gt;</code> if we don’t need to access any states of the coroutine.</li>
</ul>
<h3 id="3-How-to-release-coroutine-safely"><a href="#3-How-to-release-coroutine-safely" class="headerlink" title="3. How to release coroutine safely?"></a>3. How to release coroutine safely?</h3><ol>
<li>Carefully consider the return type of <code>initial_suspend</code> set as <code>std::suspend_always</code> <code>std::suspend_never</code> or other custom schema.</li>
<li>Sometimes we need to access states in the coroutine as the coroutine has ended, we must set the return type of <code>final_suspend</code> as <code>std::suspend_always</code>, otherwise they’re actually wild resources which are unsafe. At the same time, place <code>handle_.destroy()</code> at the destructor of the return type with RAII.</li>
<li>Note that never call <code>handle_.destroy()</code> if the return type of <code>final_suspend</code> as <code>std::suspend_never</code>.</li>
<li>It’s better to estimate whether the coroutine is done via <code>handle_.done()</code> or not when it’s called every time. It’s callable only if it isn’t done.</li>
</ol>
<h3 id="4-Construct-promise-type-with-parameters"><a href="#4-Construct-promise-type-with-parameters" class="headerlink" title="4. Construct promise_type with parameters"></a>4. Construct <code>promise_type</code> with parameters</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">fibonacci_generator</span> &#123;<br>    <span class="hljs-comment">// Other members...</span><br><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">promise_type</span> &#123;<br>        <span class="hljs-built_in">promise_type</span>(<span class="hljs-type">int</span> dummy) &#123;<br>            std::cout &lt;&lt; <span class="hljs-string">&quot;promise_type() dummy = &quot;</span> &lt;&lt; dummy &lt;&lt; std::endl;<br>        &#125;<br>    &#125;;<br>&#125;;<br><br><span class="hljs-function">fibonacci_generator <span class="hljs-title">fib</span><span class="hljs-params">(<span class="hljs-type">int</span> dummy)</span> </span>&#123;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>It can be understanded that the coroutine is initialized by some parameters.</p>
<h2 id="Example-Pop-up-elements-from-multiple-vectors"><a href="#Example-Pop-up-elements-from-multiple-vectors" class="headerlink" title="Example: Pop up elements from multiple vectors"></a>Example: Pop up elements from multiple vectors</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs C++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;coroutine&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">pop_up_generator</span> &#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">promise_type</span> &#123;<br>        <span class="hljs-built_in">promise_type</span>() &#123;<br>        &#125;<br><br>        <span class="hljs-type">int</span> current_&#123;<span class="hljs-number">0</span>&#125;;<br><br>        <span class="hljs-function">pop_up_generator <span class="hljs-title">get_return_object</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> std::coroutine_handle&lt;promise_type&gt;::<span class="hljs-built_in">from_promise</span>(*<span class="hljs-keyword">this</span>);<br>        &#125;<br><br>        <span class="hljs-function">std::suspend_always <span class="hljs-title">initial_suspend</span><span class="hljs-params">()</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> &#123;&#125;;<br>        &#125;<br><br>        <span class="hljs-function">std::suspend_always <span class="hljs-title">final_suspend</span><span class="hljs-params">()</span> <span class="hljs-keyword">noexcept</span> </span>&#123;<br>            <span class="hljs-keyword">return</span> &#123;&#125;;<br>        &#125;<br><br>        <span class="hljs-function">std::suspend_always <span class="hljs-title">yield_value</span><span class="hljs-params">(<span class="hljs-type">int</span> value)</span> </span>&#123;<br>            current_ = value;<br>            <span class="hljs-keyword">return</span> &#123;&#125;;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">unhandled_exception</span><span class="hljs-params">()</span> </span>&#123;<br>            std::<span class="hljs-built_in">terminate</span>();<br>        &#125;<br>    &#125;;<br><br>    std::coroutine_handle&lt;promise_type&gt; handle_;<br><br>    <span class="hljs-built_in">pop_up_generator</span>(std::coroutine_handle&lt;promise_type&gt; handle) : handle_&#123;handle&#125; &#123;<br>    &#125;<br><br>    ~<span class="hljs-built_in">pop_up_generator</span>() &#123;<br>        handle_.<span class="hljs-built_in">destroy</span>();<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">done</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (!handle_.<span class="hljs-built_in">done</span>()) &#123;<br>            handle_.<span class="hljs-built_in">resume</span>();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> handle_.<span class="hljs-built_in">done</span>();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">operator</span><span class="hljs-params">()</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> handle_.<span class="hljs-built_in">promise</span>().current_;<br>    &#125;<br>&#125;;<br><br><span class="hljs-function">pop_up_generator <span class="hljs-title">pop_up</span><span class="hljs-params">(std::vector&lt;<span class="hljs-type">int</span>&gt; a, std::vector&lt;<span class="hljs-type">int</span>&gt; b)</span> </span>&#123;<br>    <span class="hljs-keyword">auto</span> a_it = a.<span class="hljs-built_in">begin</span>(), b_it = b.<span class="hljs-built_in">begin</span>();<br><br>    <span class="hljs-keyword">while</span> (a_it != a.<span class="hljs-built_in">end</span>() || b_it != b.<span class="hljs-built_in">end</span>()) &#123;<br>        <span class="hljs-keyword">if</span> (a_it != a.<span class="hljs-built_in">end</span>()) &#123;<br>            <span class="hljs-keyword">co_yield</span> *a_it;<br>            ++a_it;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (b_it != b.<span class="hljs-built_in">end</span>()) &#123;<br>            <span class="hljs-keyword">co_yield</span> *b_it;<br>            ++b_it;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    std::vector&lt;<span class="hljs-type">int</span>&gt; a&#123;<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>&#125;;<br>    std::vector&lt;<span class="hljs-type">int</span>&gt; b&#123;<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>&#125;;<br><br>    pop_up_generator pop_up_gen = <span class="hljs-built_in">pop_up</span>(a, b);<br>    <span class="hljs-keyword">while</span> (!pop_up_gen.<span class="hljs-built_in">done</span>()) &#123;<br>        std::cout &lt;&lt; <span class="hljs-built_in">pop_up_gen</span>() &lt;&lt; std::endl;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><blockquote>
<p>The sub items below are where coroutines can be used.</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=ImLFlLjSveM">How C++20 Changes the Way We Write Code - Timur Doumler - CppCon 2020</a><ul>
<li>Generator</li>
<li>Compiler</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=8sEe-4tig_A">C++20’s Coroutines for Beginners - Andreas Fertig - CppCon 2022</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=J7fYddslH0Q">Deciphering C++ Coroutines - A Diagrammatic Coroutine Cheat Sheet - Andreas Weis - CppCon 2022</a><ul>
<li>syncronous <code>read()</code> and asyncronous <code>co_await async_read</code></li>
</ul>
</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/dev/" class="category-chain-item">dev</a>
  
  
    <span>></span>
    
  <a href="/categories/dev/cpp/" class="category-chain-item">cpp</a>
  
  
    <span>></span>
    
  <a href="/categories/dev/cpp/stl/" class="category-chain-item">stl</a>
  
  

  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/cpp/">#cpp</a>
      
        <a href="/tags/cpp20/">#cpp20</a>
      
        <a href="/tags/stl/">#stl</a>
      
        <a href="/tags/coroutines/">#coroutines</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Introduction to C++20 Coroutines - Part 1 Generator</div>
      <div>http://wasprime.github.io/2023/04/08/Introduction-to-C-20-Coroutines-Part-1-Generator/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>wasPrime</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>April 8, 2023</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Updated on</div>
          <div>April 9, 2023</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/04/07/NET-HttpWebRequest-Connection-Limit/" title=".NET HttpWebRequest Connection Limit">
                        <span class="hidden-mobile">.NET HttpWebRequest Connection Limit</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
